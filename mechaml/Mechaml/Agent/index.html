<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Agent (mechaml.Mechaml.Agent)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../../index.html">mechaml</a> &#x00BB; <a href="../index.html">Mechaml</a> &#x00BB; Agent</nav><h1>Module <code>Mechaml.Agent</code></h1></header><aside><p>Scraping agent</p><p>Mechaml is a web agent that allows to :</p><ul><li>Fetch and parse HTML pages</li><li>Analyze, fill and submit HTML forms</li><li>Manages cookies, headers and redirections</li></ul><p>It is built on top of Cohttp, Lwt and Lambdasoup.</p></aside><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type </span>t</code></dt><dt class="spec type" id="type-http_status_code"><a href="#type-http_status_code" class="anchor"></a><code><span class="keyword">type </span>http_status_code</code><code><span class="keyword"> = </span>Cohttp.Code.status_code</code></dt><dt class="spec type" id="type-http_headers"><a href="#type-http_headers" class="anchor"></a><code><span class="keyword">type </span>http_headers</code><code><span class="keyword"> = </span>Cohttp.Header.t</code></dt></dl><section><header><h2 id="operations-on-http-responses"><a href="#operations-on-http-responses" class="anchor"></a>Operations on HTTP responses</h2></header><dl><dt class="spec module" id="module-HttpResponse"><a href="#module-HttpResponse" class="anchor"></a><code><span class="keyword">module </span><a href="HttpResponse/index.html">HttpResponse</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>The HttpResponse module defines a type and operations to extract content and metadata from the server response</p></dd></dl><dl><dt class="spec type" id="type-result"><a href="#type-result" class="anchor"></a><code><span class="keyword">type </span>result</code><code><span class="keyword"> = </span><a href="index.html#type-t">t</a><span class="keyword"> * </span><a href="HttpResponse/index.html#type-t">HttpResponse.t</a></code></dt></dl><section><header><h3 id="main-operations"><a href="#main-operations" class="anchor"></a>Main operations</h3></header><dl><dt class="spec value" id="val-init"><a href="#val-init" class="anchor"></a><code><span class="keyword">val </span>init : ?&#8288;max_redirect:int <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p>Create a new empty agent. <code>~max_redirect</code> indicates how many times the agent will automatically and consecutively follow the <code>Location</code> header in case of an HTTP 302 or 303 response code, to avoid a redirect loop. Set to <code>0</code> to disable automatic redirection.</p></dd></dl><aside><p>The following functions perform a get request to the specified URI. <code>get &quot;http://www.site/some/url&quot; agent</code> sends a HTTP GET request and return the updated state of the agent together with the server response</p></aside><dl><dt class="spec value" id="val-get"><a href="#val-get" class="anchor"></a><code><span class="keyword">val </span>get : string <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-result">result</a> Lwt.t</code></dt><dt class="spec value" id="val-get_uri"><a href="#val-get_uri" class="anchor"></a><code><span class="keyword">val </span>get_uri : Uri.t <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-result">result</a> Lwt.t</code></dt><dt class="spec value" id="val-click"><a href="#val-click" class="anchor"></a><code><span class="keyword">val </span>click : <a href="../Page/Link/index.html#type-t">Page.Link.t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-result">result</a> Lwt.t</code></dt><dd><p>Same as get, but work directly with links instead of URIs</p></dd></dl><aside><p>The following functions send a raw post request to the specified URI</p></aside><dl><dt class="spec value" id="val-post"><a href="#val-post" class="anchor"></a><code><span class="keyword">val </span>post : string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-result">result</a> Lwt.t</code></dt><dt class="spec value" id="val-post_uri"><a href="#val-post_uri" class="anchor"></a><code><span class="keyword">val </span>post_uri : Uri.t <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-result">result</a> Lwt.t</code></dt><dt class="spec value" id="val-submit"><a href="#val-submit" class="anchor"></a><code><span class="keyword">val </span>submit : <a href="../Page/Form/index.html#type-t">Page.Form.t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-result">result</a> Lwt.t</code></dt><dd><p>Submit a filled form</p></dd></dl><aside><p>Save some downloaded content in a file</p></aside><dl><dt class="spec value" id="val-save_image"><a href="#val-save_image" class="anchor"></a><code><span class="keyword">val </span>save_image : string <span>&#45;&gt;</span> <a href="../Page/Image/index.html#type-t">Page.Image.t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-result">result</a> Lwt.t</code></dt><dd><p><code>save_image &quot;/path/to/myfile.jpg&quot; image agent</code> loads the image using <code>get</code>, opens <code>myfile.jpg</code>, write the content in asynchronously and then returns the result</p></dd></dl><dl><dt class="spec value" id="val-save_content"><a href="#val-save_content" class="anchor"></a><code><span class="keyword">val </span>save_content : string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> unit Lwt.t</code></dt><dd><p><code>save_content &quot;/path/to/myfile.html&quot; content</code> writes the specified content in a file using Lwt asynchronous I/O</p></dd></dl><dl><dt class="spec value" id="val-cookie_jar"><a href="#val-cookie_jar" class="anchor"></a><code><span class="keyword">val </span>cookie_jar : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../Cookiejar/index.html#type-t">Cookiejar.t</a></code></dt><dd><p>Return the current Cookiejar</p></dd></dl><dl><dt class="spec value" id="val-set_cookie_jar"><a href="#val-set_cookie_jar" class="anchor"></a><code><span class="keyword">val </span>set_cookie_jar : <a href="../Cookiejar/index.html#type-t">Cookiejar.t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p>Set the current Cookiejar</p></dd></dl><dl><dt class="spec value" id="val-add_cookie"><a href="#val-add_cookie" class="anchor"></a><code><span class="keyword">val </span>add_cookie : <a href="../Cookiejar/Cookie/index.html#type-t">Cookiejar.Cookie.t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p>Add a single cookie to the current Cookiejar</p></dd></dl><dl><dt class="spec value" id="val-remove_cookie"><a href="#val-remove_cookie" class="anchor"></a><code><span class="keyword">val </span>remove_cookie : <a href="../Cookiejar/Cookie/index.html#type-t">Cookiejar.Cookie.t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p>Remove a single cookie from the Cookiejar</p></dd></dl><section><header><h4 id="headers"><a href="#headers" class="anchor"></a>Headers</h4></header><dl><dt class="spec value" id="val-client_headers"><a href="#val-client_headers" class="anchor"></a><code><span class="keyword">val </span>client_headers : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> Cohttp.Header.t</code></dt><dd><p>Return the default headers sent when performing HTTP requests</p></dd></dl><dl><dt class="spec value" id="val-set_client_headers"><a href="#val-set_client_headers" class="anchor"></a><code><span class="keyword">val </span>set_client_headers : Cohttp.Header.t <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p>Use the specified headers as new default headers</p></dd></dl><dl><dt class="spec value" id="val-add_client_header"><a href="#val-add_client_header" class="anchor"></a><code><span class="keyword">val </span>add_client_header : string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p>Add a single key/value pair to the default headers</p></dd></dl><dl><dt class="spec value" id="val-remove_client_header"><a href="#val-remove_client_header" class="anchor"></a><code><span class="keyword">val </span>remove_client_header : string <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p>Remove a single key/value pair from the default headers</p></dd></dl></section><section><header><h4 id="redirection"><a href="#redirection" class="anchor"></a>Redirection</h4></header><dl><dt class="spec value" id="val-set_max_redirect"><a href="#val-set_max_redirect" class="anchor"></a><code><span class="keyword">val </span>set_max_redirect : int <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dd><p>Set the maximum consecutive redirections (to avoid infinite loops). Use <code>0</code> to disable automatic redirection)</p></dd></dl><dl><dt class="spec value" id="val-default_max_redirect"><a href="#val-default_max_redirect" class="anchor"></a><code><span class="keyword">val </span>default_max_redirect : int</code></dt><dd><p>The default maximum consecutive redirections</p></dd></dl></section><section><header><h4 id="the-agent-monad"><a href="#the-agent-monad" class="anchor"></a>The Agent Monad</h4><p>This module defines a monad that implicitly manages the state corresponding to the agent while being inside the Lwt monad. This is basically the state monad (for <a href="index.html#type-t"><code>Agent.t</code></a>) and the Lwt one stacked</p></header><div class="spec module" id="module-Monad"><a href="#module-Monad" class="anchor"></a><code><span class="keyword">module </span><a href="Monad/index.html">Monad</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div></section></section></section></div></body></html>